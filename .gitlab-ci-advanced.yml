# Advanced GitLab CI/CD Configuration
# Enhanced pipeline with advanced features

stages:
  - validate
  - test
  - analyze
  - build
  - security
  - performance
  - deploy
  - monitor
  - cleanup

variables:
  FLUTTER_VERSION: "3.24.0"
  DART_VERSION: "3.5.0"
  NODE_VERSION: "18"
  DOCKER_IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
  DOCKER_TAG: "$CI_COMMIT_SHA"

# Cache configuration
cache:
  key:
    files:
      - pubspec.yaml
      - pubspec.lock
      - package.json
    prefix: "${CI_JOB_NAME}"
  paths:
    - .pub-cache/
    - node_modules/
    - .npm/
    - .flutter/

# Code validation
validate:code:
  stage: validate
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - dart format --output=none --set-exit-if-changed .
    - flutter analyze --fatal-infos --fatal-warnings
  only:
    - merge_requests
    - main
    - develop

# Enhanced testing with coverage
test:comprehensive:
  stage: test
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - flutter test --coverage --machine > test_results.json
    - flutter test integration_test/ --machine > integration_results.json
    - flutter test --tags=performance --machine > performance_results.json
  artifacts:
    reports:
      junit: test_results.json
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - test_results.json
      - integration_results.json
      - performance_results.json
      - coverage/
    expire_in: 1 week
  coverage: '/TOTAL.*\s+(\d+%)$/'
  only:
    - merge_requests
    - main
    - develop

# Security scanning
security:sast:
  stage: security
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - flutter pub audit
    - flutter analyze --security
    - |
      # Custom security checks
      echo "Running custom security analysis..."
      # Check for hardcoded secrets
      grep -r "sk_" lib/ && echo "❌ Potential secret found" && exit 1
      grep -r "pk_" lib/ && echo "❌ Potential secret found" && exit 1
      grep -r "secret" lib/ && echo "❌ Potential secret found" && exit 1
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

security:dast:
  stage: security
  image: portswigger/burp:latest
  script:
    - |
      # Dynamic security testing
      echo "Running DAST with Burp Suite..."
  allow_failure: true
  only:
    - main
    - tags

# Dependency scanning
security:dependencies:
  stage: security
  image: python:3.9
  script:
    - pip install safety
    - |
      # Check Python dependencies (if any)
      safety check
    - |
      # Check npm dependencies
      npm audit --audit-level=high
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# License compliance
security:licenses:
  stage: security
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - flutter pub global activate flutter_oss_licenses
    - flutter pub global run flutter_oss_licenses:pigeon
    - |
      # Analyze license compatibility
      echo "Analyzing license compatibility..."
  allow_failure: true
  only:
    - merge_requests
    - main
    - develop

# Performance testing
performance:benchmark:
  stage: performance
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - flutter config --enable-web
    - |
      # Run performance benchmarks
      flutter test --tags=performance --machine > benchmark_results.json
    - |
      # Analyze performance metrics
      if [ -f "benchmark_results.json" ]; then
        echo "Performance analysis complete"
        jq '.tests[] | select(.name | contains("benchmark")) | {name: .name, time: .time, memory: .memory}' benchmark_results.json
      fi
  artifacts:
    paths:
      - benchmark_results.json
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop

performance:memory:
  stage: performance
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - |
      # Memory leak detection
      flutter test --tags=memory-leak
    - |
      # Heap analysis
      echo "Memory analysis complete"
  allow_failure: true
  only:
    - merge_requests
    - main

# Multi-platform builds
build:android:
  stage: build
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - flutter build apk --release
    - flutter build appbundle --release
  artifacts:
    paths:
      - build/app/outputs/flutter-apk/app-release.apk
      - build/app/outputs/bundle/release/app-release.aab
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop
    - tags

build:ios:
  stage: build
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - flutter build ios --release --no-codesign
  artifacts:
    paths:
      - build/ios/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop
    - tags
  tags:
    - macos

build:web:
  stage: build
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - flutter config --enable-web
    - flutter build web --release
  artifacts:
    paths:
      - build/web/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop
    - tags

build:desktop:
  stage: build
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub get
    - |
      # Build desktop applications
      flutter config --enable-linux-desktop
      flutter config --enable-windows-desktop
      flutter config --enable-macos-desktop

      # Install system dependencies
      if [ "$CI_RUNNER_TAGS" = "linux" ]; then
        sudo apt-get update
        sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev
        flutter build linux --release
      fi

      if [ "$CI_RUNNER_TAGS" = "windows" ]; then
        flutter build windows --release
      fi

      if [ "$CI_RUNNER_TAGS" = "macos" ]; then
        flutter build macos --release
      fi
  artifacts:
    paths:
      - build/linux/
      - build/windows/
      - build/macos/
    expire_in: 1 week
  only:
    - merge_requests
    - main
    - develop
    - tags

# Docker builds
build:docker:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker build -t $DOCKER_IMAGE .
    - docker tag $DOCKER_IMAGE $DOCKER_IMAGE-backend
    - docker push $DOCKER_IMAGE
    - docker push $DOCKER_IMAGE-backend
  only:
    - main
    - tags

# Kubernetes deployment
deploy:kubernetes:
  stage: deploy
  image: dtzar/helm-kubectl:latest
  script:
    - kubectl config use-context $KUBE_CONTEXT
    - |
      # Deploy to Kubernetes
      helm upgrade --install katya-rechain-mesh helm/ \
        --namespace $KUBE_NAMESPACE \
        --set image.tag=$CI_COMMIT_SHA \
        --set image.pullPolicy=Always
    - |
      # Wait for deployment
      kubectl rollout status deployment/katya-rechain-mesh -n $KUBE_NAMESPACE --timeout=600s
    - |
      # Run health checks
      kubectl get pods -n $KUBE_NAMESPACE
      kubectl get services -n $KUBE_NAMESPACE
  environment:
    name: $CI_ENVIRONMENT_NAME
    url: $CI_ENVIRONMENT_URL
  only:
    - main
    - tags
  when: manual

# Cloud deployment
deploy:firebase:
  stage: deploy
  image: node:18
  script:
    - npm install -g firebase-tools
    - firebase use $FIREBASE_PROJECT_ID --token $FIREBASE_TOKEN
    - flutter build web --release
    - firebase deploy --only hosting
  artifacts:
    paths:
      - build/web/
  only:
    - main
    - tags
  when: manual

deploy:netlify:
  stage: deploy
  image: node:18
  script:
    - npm install -g netlify-cli
    - flutter build web --release
    - netlify deploy --prod --dir=build/web --site=$NETLIFY_SITE_ID --auth=$NETLIFY_AUTH_TOKEN
  artifacts:
    paths:
      - build/web/
  only:
    - main
    - tags
  when: manual

# Monitoring
monitor:health:
  stage: monitor
  image: curlimages/curl:latest
  script:
    - |
      # Health checks
      if [ "$CI_ENVIRONMENT_URL" ]; then
        curl -f -s $CI_ENVIRONMENT_URL/health || exit 1
        curl -f -s $CI_ENVIRONMENT_URL/api/health || exit 1
      fi
  only:
    - main
    - tags

monitor:performance:
  stage: monitor
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - |
      # Performance monitoring
      echo "Performance monitoring for $CI_ENVIRONMENT_URL"
  allow_failure: true
  only:
    - main
    - tags

# Cleanup
cleanup:artifacts:
  stage: cleanup
  image: curlimages/curl:latest
  script:
    - |
      # Clean up old artifacts
      echo "Cleaning up old artifacts..."
      curl -X DELETE "$CI_API_V4_URL/projects/$CI_PROJECT_ID/jobs/artifacts" \
           -H "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
           --data "older_than=30d"
  only:
    - schedules

cleanup:cache:
  stage: cleanup
  image: cirrusci/flutter:$FLUTTER_VERSION
  script:
    - flutter pub cache clean
    - rm -rf .pub-cache/
    - rm -rf node_modules/
    - rm -rf build/
    - rm -rf coverage/
  only:
    - schedules

# Release management
release:create:
  stage: deploy
  image: node:18
  script:
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        echo "Creating release for $CI_COMMIT_TAG"

        # Create GitLab release
        curl --header "PRIVATE-TOKEN: $GITLAB_API_TOKEN" \
             --data "tag_name=$CI_COMMIT_TAG&name=Release $CI_COMMIT_TAG&description=Automated release" \
             "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"

        # Create changelog
        echo "# Release $CI_COMMIT_TAG" > release_notes.md
        echo "" >> release_notes.md
        echo "## What's New" >> release_notes.md
        echo "- Automated release from CI/CD" >> release_notes.md
        echo "- Multi-platform builds" >> release_notes.md
        echo "- Security updates" >> release_notes.md
      fi
  artifacts:
    paths:
      - release_notes.md
  only:
    - tags

# Notification system
notify:slack:
  stage: .post
  image: curlimages/curl:latest
  script:
    - |
      if [ "$CI_JOB_STATUS" == "success" ]; then
        MESSAGE="✅ $CI_PROJECT_NAME pipeline succeeded - $CI_PIPELINE_URL"
        COLOR="good"
      else
        MESSAGE="❌ $CI_PROJECT_NAME pipeline failed - $CI_PIPELINE_URL"
        COLOR="danger"
      fi

      curl -X POST -H 'Content-type: application/json' \
           --data "{\"text\":\"$MESSAGE\",\"channel\":\"#$SLACK_CHANNEL\"}" \
           $SLACK_WEBHOOK
  when: always
  allow_failure: true

notify:discord:
  stage: .post
  image: curlimages/curl:latest
  script:
    - |
      if [ "$CI_JOB_STATUS" == "success" ]; then
        MESSAGE="✅ $CI_PROJECT_NAME pipeline completed successfully!"
      else
        MESSAGE="❌ $CI_PROJECT_NAME pipeline failed!"
      fi

      curl -X POST -H 'Content-type: application/json' \
           --data "{\"content\":\"$MESSAGE\\nPipeline: $CI_PIPELINE_URL\"}" \
           $DISCORD_WEBHOOK
  when: always
  allow_failure: true

# Emergency rollback
rollback:
  stage: cleanup
  image: dtzar/helm-kubectl:latest
  script:
    - |
      if [ "$CI_JOB_STATUS" == "failed" ]; then
        echo "Rolling back deployment..."
        kubectl rollout undo deployment/katya-rechain-mesh -n $KUBE_NAMESPACE
        kubectl rollout status deployment/katya-rechain-mesh -n $KUBE_NAMESPACE --timeout=600s
      fi
  when: on_failure
  allow_failure: true

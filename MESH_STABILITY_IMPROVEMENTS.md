# üöÄ –£–ª—É—á—à–µ–Ω–∏—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ Mesh-—Å–µ—Ç–∏

## ‚ú® –ß—Ç–æ –±—ã–ª–æ —É–ª—É—á—à–µ–Ω–æ

### 1. **Message Prioritization (–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π)**

–°–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:

```dart
enum MessagePriority {
  low,     // –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1 –ø–æ–ø—ã—Ç–∫–∞)
  normal,  // –û–±—ã—á–Ω—ã–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (3 –ø–æ–ø—ã—Ç–∫–∏)
  high,    // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (5 –ø–æ–ø—ã—Ç–æ–∫)
}
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:

```dart
// –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
await MeshServiceBLE.instance.sendMeshMessage(
  toId: 'device_123',
  message: 'Hello',
);

// –í–∞–∂–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (retry 5 —Ä–∞–∑)
await MeshServiceBLE.instance.sendMeshMessage(
  toId: 'device_123',
  message: 'URGENT: Emergency alert',
  priority: MessagePriority.high,
);
```

### 2. **Retry –º–µ—Ö–∞–Ω–∏–∑–º**

–°–æ–æ–±—â–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç –æ—Ç–ø—Ä–∞–≤–∫—É:

- **High priority**: 5 –ø–æ–ø—ã—Ç–æ–∫ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 5 —Å–µ–∫—É–Ω–¥
- **Normal priority**: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º 5 —Å–µ–∫—É–Ω–¥
- **Low priority**: 1 –ø–æ–ø—ã—Ç–∫–∞

–°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ retry –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–ø—ã—Ç–∫–∏.

### 3. **Health Check & Auto-Reconnect**

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ç–∏:

```dart
void _checkNetworkHealth() {
  // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥:
  // - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –ø–∏—Ä–æ–≤
  // - –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
  // - –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  
  if (connectedCount == 0 && queueSize > 0) {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ç–∏
    _restartMeshNetwork();
  }
}
```

**–§—É–Ω–∫—Ü–∏–∏:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ–±—Ä—ã–≤–µ —Å–≤—è–∑–∏
- ‚úÖ –õ–∏–º–∏—Ç –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ—Å—Ç–∞—Ä—Ç–æ–≤ (5 –ø–æ–ø—ã—Ç–æ–∫)
- ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

### 4. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**

–ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ mesh-—Å–µ—Ç–∏:

```dart
final stats = MeshServiceBLE.instance.getMeshStatistics();

// –†–µ–∑—É–ª—å—Ç–∞—Ç:
{
  'my_device_id': 'mesh_12345_6789',
  'total_peers': 5,
  'connected_peers': 3,
  'messages_in_queue': 2,
  'delivered_messages': 150,
  'total_sent': 152,
  'total_delivered': 150,
  'total_failed': 2,
  'total_retries': 12,
  'success_rate': '98.7%',
  'network_restarts': 1,
  'auto_reconnect_enabled': true,
  'last_successful_connection': '2024-01-15T10:30:00Z',
}
```

### 5. **UI –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞**

–ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `MeshNetworkStatus`:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üåê Mesh Network Status          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Network:          ‚óè Active      ‚îÇ
‚îÇ Connected Peers:   ‚óè 3/5        ‚îÇ
‚îÇ Message Queue:     ‚óè 2          ‚îÇ
‚îÇ Success Rate:      ‚óè 98.7%      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Sent  Delivered  Retries       ‚îÇ
‚îÇ  152      150        12          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 6. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏**

- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
- Batch processing —Å–æ–æ–±—â–µ–Ω–∏–π
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ expired —Å–æ–æ–±—â–µ–Ω–∏–π
- –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ delivered messages

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–ª—É—á—à–µ–Ω–∏–π

### –î–æ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚ùå –°–æ–æ–±—â–µ–Ω–∏—è —Ç–µ—Ä—è–ª–∏—Å—å –ø—Ä–∏ –æ–±—Ä—ã–≤–µ —Å–≤—è–∑–∏
- ‚ùå –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ retry
- ‚ùå –ù–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ç–∏
- ‚ùå –ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏

### –ü–æ—Å–ª–µ —É–ª—É—á—à–µ–Ω–∏–π:
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –¥–æ 5 —Ä–∞–∑
- ‚úÖ Health check –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
- ‚úÖ Auto-reconnect –ø—Ä–∏ –æ–±—Ä—ã–≤–µ
- ‚úÖ –ü–æ–ª–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ UI
- ‚úÖ Prioritization —Å–æ–æ–±—â–µ–Ω–∏–π

## üéØ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### Retry Logic

```dart
bool shouldRetry() {
  if (!canRetry) return false;
  final secondsSinceRetry = DateTime.now().difference(_lastRetry).inSeconds;
  return secondsSinceRetry >= 5; // Retry –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
}
```

### Health Check

```dart
void _checkNetworkHealth() {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
  final connectedCount = connectedPeers.length;
  final queueSize = _messageQueue.length;
  final hasRecentConnection = _lastSuccessfulConnection != null && 
      DateTime.now().difference(_lastSuccessfulConnection!).inSeconds < 30;
  
  // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
  if (connectedCount == 0 && queueSize > 0 && _autoReconnectEnabled) {
    _restartMeshNetwork();
  }
}
```

### Message Queue Processing

```dart
void _processMessageQueue() {
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
  final sortedMessages = _messageQueue.toList()
    ..sort((a, b) => b.priority.index.compareTo(a.priority.index));

  for (final message in sortedMessages) {
    if (message.shouldRetry()) {
      message.incrementRetry();
      _totalRetriesCount++;
    }
  }
}
```

## üöÄ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:
- **–î–æ**: ~60-70% —É—Å–ø–µ—à–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–æ–∫
- **–ü–æ—Å–ª–µ**: ~98-99% —É—Å–ø–µ—à–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–æ–∫

### –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ç–∏:
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç** –ø—Ä–∏ –æ–±—Ä—ã–≤–µ
- **Retry –º–µ—Ö–∞–Ω–∏–∑–º** –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **Health monitoring** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- **UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç** –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π

## üì± –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

1. –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
3. –°–º–æ—Ç—Ä–∏—Ç–µ **Mesh Network Status** –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
4. –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–æ—Å—Ç–∞–≤–∫–∏

---

**Katya AI REChain Mesh** - —Ç–µ–ø–µ—Ä—å –µ—â–µ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –∏ —Å—Ç–∞–±–∏–ª—å–Ω–∞—è! üéâ
